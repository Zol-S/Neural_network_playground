define([
	'jquery',
	'underscore',
	'backbonejs',
	'text!backbone/templates/number_recognizer.html',
	'synaptic',
	'bootstrap'
], function ($, _, Backbone, numberRecognizerTemplate, synaptic) {
	'use strict';

	var view = Backbone.View.extend({
		el: '#main',
		mnist_digits: [
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.3210000000000002,3.592,2.737,0,0,0,0,0,0,0,0,0,0.039,1.325,3.862,3.705,3.2190000000000003,1.718,0,0,0,0,0,0,0,0,1.772,3.96,3.172,3.862,1.611,3.306,0,0,0,0,0,0,0,0.984,3.8270000000000004,2.835,0.34099999999999997,0.5569999999999999,0,3.925,0.843,0,0,0,0,0,0.251,3.662,1.4659999999999997,0.185,0,0,0,3.96,1.53,0,0,0,0,0,2.039,3.164,0,0,0,0,0,3.972,1.349,0,0,0,0,0,2.642,1.875,0,0,0,0.027,2.058,2.8810000000000002,0.047,0,0,0,0,0,2.65,1.451,0,0,0.447,2.76,2.301,0,0,0,0,0,0,0,2.642,3.525,2.043,3.007,3.6310000000000002,2.04,0.22,0,0,0,0,0,0,0,0.988,3.4659999999999997,3.96,2.6,0.569,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 0
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.478,1.2469999999999999,0,0,0,0,0,0,0,0,0,0,0,0.874,3.909,2.4699999999999998,0,0,0,0,0,0,0,0,0,0,0.235,3.0700000000000003,3.1639999999999997,0.153,0,0,0,0,0,0,0,0,0,0,1.678,3.89,1,0,0,0,0,0,0,0,0,0,0,0.5329999999999999,3.7720000000000002,2.2590000000000003,0,0,0,0,0,0,0,0,0,0,0.125,3.239,3.357,0.09,0,0,0,0,0,0,0,0,0,0,1.647,3.936,1.812,0,0,0,0,0,0,0,0,0,0,0,3.878,3.0860000000000003,0.047,0,0,0,0,0,0,0,0,0,0,1.706,3.953,1.6939999999999997,0,0,0,0,0,0,0,0,0,0,0,2.4699999999999998,3.71,0,0,0,0,0,0,0,0,0,0,0,0,0.851,1.855,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 1
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.051,0.49,0.505,0,0,0,0,0,0,0,0,0,0.157,1.682,3.388,3.681,3.459,0.157,0,0,0,0,0,0,0,0.435,3.509,3.952,2.8,0.41200000000000003,3.952,0.47,0,0,0,0,0,0,0,0.8119999999999999,2.7049999999999996,1.604,0.118,0.694,3.952,0.47,0,0,0,0,0,0,0,0,0,0.431,0.953,1.883,3.725,0.247,0,0,0,0,0,0,0,0.23199999999999998,2.125,3.541,3.6079999999999997,3.96,2.3960000000000004,0.024,0,0,0,0,0,0,0.5730000000000001,3.27,2.2470000000000003,0.313,2.675,3.4509999999999996,3.642,2.0780000000000003,0.451,0.192,0,0,0,0.424,3.4579999999999997,1.777,1.02,2.937,2.4429999999999996,0.255,0.33699999999999997,1.933,3.388,1.02,0,0,0,1.718,3.925,3.6270000000000002,3.129,1.631,0.012,0,0,0,0,0,0,0,0,0.051,0.926,0.565,0.024,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 2
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.149,0.581,1.992,1.984,1.984,0.7060000000000001,0,0,0,0,0,0,0,0.867,3.399,3.85,3.96,3.952,3.952,3.584,0.28600000000000003,0,0,0,0,0,0,0.443,2.2039999999999997,1.514,1.04,1.3139999999999998,3.85,3.6390000000000002,0.258,0,0,0,0,0,0,0,0,0,0,1.419,3.917,2.596,0,0,0,0,0,0,0,0.125,1.2469999999999999,1.514,3.1679999999999997,3.933,3.3089999999999997,0.9450000000000001,0,0,0,0,0,0,0,2.098,3.96,3.96,3.972,3.96,1.976,0,0,0,0,0,0,0,0,0.122,0.6859999999999999,0.346,0.346,2.596,2.556,0,0,0,0,0,0,0,0.314,0.035,0,0,0.384,3.262,2.556,0,0,0,0,0,0,1.055,3.682,1.2149999999999999,1.05,1.392,3.278,3.701,1.533,0,0,0,0,0,0,1.008,3.58,3.952,3.952,3.6390000000000002,2.6430000000000002,0.631,0,0,0,0,0,0,0,0,0.43100000000000005,1.9100000000000001,1.0790000000000002,0.094,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 3
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.173,0.153,0,0,0,0,1.694,0,0,0,0,0,0,0.008,2.601,0.31,0,0,0,0,3.0120000000000005,0,0,0,0,0,0,0.824,3.117,0,0,0,0,0.651,3.2350000000000003,0,0,0,0,0,0,1.772,2.3259999999999996,0,0,0,0,1.248,2.726,0,0,0,0,0.055,1.035,3.604,1.267,0,0,0,0,1.212,3.25,1.624,1.988,2.623,2.87,2.816,1.7500000000000002,3.827,0.157,0,0,0,0,0,1.161,1.388,1.388,0.604,0,0,1.0630000000000002,3.392,0,0,0,0,0,0,0,0,0,0,0,0,1.326,2.4400000000000004,0,0,0,0,0,0,0,0,0,0,0,0,1.326,2.741,0,0,0,0,0,0,0,0,0,0,0,0,1.326,3.196,0,0,0,0,0,0,0,0,0,0,0,0,0.376,1.596,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 4
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.08299999999999999,0.142,1.0270000000000001,0.788,1.651,1.467,0,0,0,0,0,0.192,2.184,2.957,3.643,3.968,3.96,2.2439999999999998,2.483,1.169,0,0,0,0,0,0.071,2.777,3.396,3.7800000000000002,1.533,2.687,0,0,0,0,0,0,0,0,0,0.055,1.153,3.082,0.008,0,0,0,0,0,0,0,0,0,0,0,0.043,2.819,1.784,0.428,0,0,0,0,0,0,0,0,0,0,0,0.318,2.838,3.443,0.7919999999999999,0,0,0,0,0,0,0,0,0,0,0,0.063,2.3289999999999997,3.693,0.251,0,0,0,0,0,0,0,0,0,0.733,2.58,3.694,3.4979999999999998,0.008,0,0,0,0,0,0,0,0.349,2.368,3.843,3.752,2.106,0.306,0,0,0,0,0,0,0.891,2.62,3.835,3.933,2.322,0.349,0,0,0,0,0,0,0,0,1.525,1.984,1.3599999999999999,0.581,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 5
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.576,2.926,1.572,0,0,0,0,0,0,0,0,0,0,0.9369999999999999,3.745,2.518,0.075,0,0,0,0,0,0,0,0,0,0.149,3.075,3.282,0.349,0,0,0,0,0,0,0,0,0,0,2.255,2.698,0.106,0,0,0,0,0,0,0,0,0,0,0.922,3.96,1.102,0,0.435,1.098,0,0,0,0,0,0,0,0,2.0860000000000003,3.859,0.365,1.3170000000000002,3.29,3.772,2.878,0.122,0,0,0,0,0,0.33699999999999997,3.391,1.898,0.9369999999999999,3.5679999999999996,2.164,1.455,3.352,0.122,0,0,0,0,0,0.996,3.65,0.188,3.6510000000000002,1.674,1.244,3.407,0.549,0,0,0,0,0,0,0.753,3.642,0.8200000000000001,3.807,3.4859999999999998,2.91,0.153,0,0,0,0,0,0,0,0.2,2.972,3.96,3.58,2.6149999999999998,0.58,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 6
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.451,1.1099999999999999,1.984,0.835,0,0,0,0,0,0,0,0.851,1.772,2.6,3.4349999999999996,3.952,3.952,3.689,0,0,0,0,0,0,0.996,3.839,3.925,2.608,0.22799999999999998,0.996,3.842,2.647,0,0,0,0,0,0,2.937,3.725,1.3650000000000002,0,0.067,1.992,3.725,0.8160000000000001,0,0,0,0,0,0,1.129,0.839,0,0,1.746,3.937,1.3299999999999998,0,0,0,0,0,0,0,0,0,0,0.525,3.972,2.533,0,0,0,0,0,0,0,0,0,0,0.039,2.13,3.6109999999999998,0.491,0,0,0,0,0,0,0,0,0,0,1.859,3.815,0.439,0,0,0,0,0,0,0,0,0,0,0.804,3.572,1.377,0,0,0,0,0,0,0,0,0,0,0,2.396,2.596,0.153,0,0,0,0,0,0,0,0,0,0,0,1.251,0.31,0,0,0,0,0,0,0,0], // 7
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.043,1.694,0.125,0,0,0,0,0,0,0,0.176,1.329,1.702,2.352,1.6989999999999998,3.576,0.126,0,0,0,0,0,0,0,1.8940000000000001,3.596,2.5759999999999996,1.7129999999999999,3.89,2.302,0,0,0,0,0,0,0,0,2.588,2.596,0.145,2.498,3.321,0.416,0,0,0,0,0,0,0,0,1.1880000000000002,3.87,3.177,3.58,0.541,0,0,0,0,0,0,0,0,0,1.114,3.976,3.686,0.851,0,0,0,0,0,0,0,0,0,0.584,3.651,3.3920000000000003,3.466,0,0,0,0,0,0,0,0,0,0.251,3.286,1.8,1.4,3.098,0,0,0,0,0,0,0,0,0,1.04,3.482,0.373,3.2590000000000003,2.016,0,0,0,0,0,0,0,0,0,1.039,3.6390000000000002,3.6660000000000004,1.835,0,0,0,0,0,0,0,0,0,0,0.067,1.416,1.192,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0], // 8
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.7959999999999999,1.8159999999999998,1.435,0.921,0.216,0,0,0,0,0,0,0,0.016,1.514,3.6310000000000002,2.008,2.5729999999999995,3.96,1.114,0,0,0,0,0,0,0,1.8860000000000001,3.537,0.8280000000000001,0,3.18,3.168,0.082,0,0,0,0,0,0,1.467,3.639,0.725,0.141,2.113,3.604,0.549,0,0,0,0,0,0,0,2.043,3.086,2.529,3.592,3.858,2.192,0,0,0,0,0,0,0,0,0.216,1.9140000000000001,1.392,0.502,3.733,0.988,0,0,0,0,0,0,0,0,0,0,0,0.278,3.96,0.164,0,0,0,0,0,0,0,0,0,0,0,0.694,3.96,0.164,0,0,0,0,0,0,0,0,0,0,0,0.176,3.835,0.302,0,0,0,0,0,0,0,0,0,0,0,0,2.141,2.561,0.043,0,0,0,0,0,0,0,0,0,0,0,0.055,1.564,0.165,0,0,0,0] // 9
		],
		initialize: function() {
			this.size = 14;

			var _self = this;
			$.getJSON('public/js/neural/mnist_weights_14x14.json', function(json) {
				_self.net = synaptic.Network.fromJSON(json);
				$('#recognize_btn').removeAttr("disabled");

				console.log('Neural network loaded');
				$('.ajax_loader').hide();
			});
		},
		events: {
			'click #canvas div': 'onPixelClicked',
			'mouseenter #canvas div': 'onPixelHovered',
			'click #recognize_btn': 'onRecognizeClicked',
			'click #clear_btn': 'onClearClicked',
			'click .digit': 'onDigitClicked'
		},
		render: function() {
			this.$el.empty();

			var template = _.template(numberRecognizerTemplate);
			this.$el.append(template({
				base_url: window.base_url,
				public_directory: window.public_directory
			}));

			this.drawMap();
		},
		drawMap: function() {
			$('#canvas').empty();

			for (var i=0;i<this.size;i++) {
				for (var k=0;k<this.size;k++) {
					$('#canvas').append('<div id="rect_' + i + '_' + k + '" class="small_rectangle" style="top:' + (i*10) + 'px;left:' + (k*10) + 'px;"></div>');
				}
			}
		},
		onPixelHovered: function(e) {
			if (e.buttons == 1 || e.buttons == 3){
				$(e.target).toggleClass('pixel_on');
			}
		},
		onPixelClicked: function(e) {
			$(e.target).toggleClass('pixel_on');
		},
		onRecognizeClicked: function() {
			// Creating image array
			var image = new Array(196);
			for (var i=0;i<this.size;i++) {
				for (var k=0;k<this.size;k++) {
					if ($('#rect_' + i + '_' + k).hasClass('pixel_on')) {
						image[i*this.size+k] = 1;
					} else {
						image[i*this.size+k] = 0;
					}
				}
			}

			// Selecting top value
			var output = this.net.activate(image), top_value = 0, top_position = 0;
			for (var i=0;i<output.length;i++) {
				if (output[i] > top_value) {
					top_value = output[i];
					top_position = i;
				}
			}

			$('#result').text('Recognized digit: ' + top_position + ' (' + parseInt(top_value*1000000)/10000 +'%)');
			console.log('Digit with the highest probability is ' + top_position + ' (' + parseInt(top_value*1000000)/10000 +'%)');
		},
		onClearClicked: function() {
			$('#canvas div').removeClass('pixel_on');
		},
		onDigitClicked: function(e) {
			this.onClearClicked();

			for (var i=0;i<this.size;i++) {
				for (var k=0;k<this.size;k++) {
					if (this.mnist_digits[parseInt($(e.target).text())][i*this.size+k] > 0.75) {
						$('#rect_' + i + '_' + k).addClass('pixel_on');
					}
				}
			}
		},
		destroy: function() {
			this.undelegateEvents();
			this.$el.empty();
			this.stopListening();
			return this;
		}
	});

	return view;
});